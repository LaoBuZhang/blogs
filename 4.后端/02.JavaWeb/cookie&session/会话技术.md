# 会话技术

## 会话

1. 会话：一次会话中包含多次请求和响应。
	* 一次会话：浏览器第一次给服务器资源发送请求，会话建立，直到有一方断开为止
2. 功能：**在一次会话的范围内的多次请求间，共享数据**
3. 方式：
	1. 客户端会话技术：Cookie
	2. 服务器端会话技术：Session



## 使用场景

cookie：

第一次登录网站时没有cookie，可以提示欢迎第一次访问，并将访问时间存储到cookie之中

后续登陆时，有了cookie，可以更换提示内容，显示上次访问时间



session：

一个项目的验证码图片生成模块和登录模块之间一般会分开

生成验证码之后，可以存储在session之中，然后登陆模块就可以得到验证码的值





## cookie

第一次请求时将数据保存在浏览器端



### cookie的使用

cookie绑定在请求和响应之中



创建cookie对象，绑定数据

~~~java
Cookie c=new Cookie(String name,String value);
~~~

发送cookie对象

~~~java
response.addCookie(Cookie cookie);
~~~

获取cookie，拿到数据

~~~java
Cookie[] request.getCookies();
~~~





不同的浏览器属于不同的对话，不能共享cookie





### cookie原理

cookie会保存在浏览器中

在发送响应时，加上`Set-Cookie:name=value`这样的头部，当有多个cookie时会有多个`Set-Cookie`头部

在发送请求时，加上`Cookie:name=value`这样的头部，当有多个cookie时会在这一个`Cookie`头部内用`,`隔开





### cookie细节

#### cookie保存时间

默认情况下，保存在浏览器内存，浏览器关闭Cookie数据被销毁

持久化存储：

 * 改变参数`setMaxAge(int seconds)`

   ~~~java
   Cookie c=new Cookie(String name,String value);
   c.setMaxAge(30);
   ~~~

   1.  正数：将Cookie数据写到硬盘的文件中。持久化存储。并指定cookie存活时间，时间到后，cookie文件自动失效
   2. 负数：默认值
   3. 零：删除cookie信息



#### cookie能否中文

tomcat8之前不能直接存储中文数据，需要将中文数据转码，采用URL编码

tomcat8之后可以支持中文



但是特殊字符还是不支持，如空格换行之类，需要使用url编码存储和解析

编码

~~~java
String str="132 abc 你好";
str=URLEncoder.encode(str,"utf-8");
~~~

解码

~~~java
str=URLEncoder.decode(str,"utf-8");
~~~





#### cookie共享问题

默认范围是所在的路径下（所在的路径和所有子路径）

通过`setPath`参数可以设置共享范围



例如原本是`/api/amis/article`路径下才能使用该cookie

`c.setPath("/")`后就能所有路径都能共享这个cookie





不同的tomcat服务器之间共享cookie

`setDomain(String path)`可以设置一级域名相同的多个服务器之间可以共享

如`setDomain(.baidu.com)`之后，`new.baidu.com`和`tieba.baidu.com`都可以共享该cookie





### cookie的特点和作用

1. cookie存储数据在客户端浏览器
2. 浏览器对于单个cookie 的大小有限制(4kb) 以及 对同一个域名下的总cookie数量也有限制(20个)

* 作用：
	1. cookie一般用于存出少量的不太敏感的数据
	2. 在不登录的情况下，完成服务器对客户端的身份识别





## session

将数据保存在服务器端的对象`HttpSession`中



### session的使用

获取session

~~~java
HttpSessioin session=request.getSession();
//存储数据
session.setAttribute("msg","hello session");
//获取数据
Object msg=session.getAttritube("msg");
~~~





### session原理

**session依赖于cookie**

多个session都是同一个

第一次获取session时，没有cookie，会在内存中创建一个新的session对象，并给这个session生成一个唯一id，这个id会存储在cookie之中，字段名为`JSESSIONDID`

之后的`getSession`在使用时，都会从cookie中查到这个id，返回到最开始创建的session对象



### session细节

#### session客户端关闭，服务器不关闭

默认情况下，客户端关闭后，后续再使用的session就不是同一个了

可以通过自己创建的cookie保存住生成的session的`JSESSIONID`，并将设置cookie的存活时间，以此来实现后续使用的session都是同一个，这时`JSESSIONID`被保存到服务器了

#### session服务器关闭，客户端不关闭

默认不是同一个，但是要保证数据不丢失

session的钝化：

在服务器正常关闭之前，将session对象序列化到硬盘上

session的活化：

启动服务器后，将session文件转化为内存中的session对象



#### session什么时候销毁

1. 服务器关闭时销毁

2. session对象调用`invalidate()`方法时销毁

3. session默认失效时间时30分钟

   可以通过修改tomcat的配置文件`web.xml`来修改默认时长

   ~~~xml
   <session-config>
       <session-timeout>30</session-timeout>
   </session-config>
   ~~~

   



### session特点

可以存储任意类型，任意大小的数据

session相对于cookie更安全